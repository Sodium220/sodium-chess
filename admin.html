<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Admin - Bracket Manager</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; padding: 20px; }
        
        /* Bracket Container */
        .bracket-container { display: flex; overflow-x: auto; padding: 40px; gap: 50px; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; min-width: 200px; }
        
        /* Match Box */
        .match-box { background: #333; border: 1px solid #555; border-radius: 5px; margin: 10px 0; position: relative; }
        .player-slot { 
            padding: 8px 12px; border-bottom: 1px solid #444; height: 30px; display: flex; 
            justify-content: space-between; align-items: center; cursor: pointer; position: relative;
        }
        .player-slot:last-child { border-bottom: none; }
        .player-slot input { background: transparent; border: none; color: white; width: 80%; outline: none; font-size: 14px; }
        
        /* Connector Lines (Pure CSS Tree) */
        .match-box::after {
            content: ""; position: absolute; right: -25px; top: 50%; width: 25px; height: 2px; background: #555;
        }
        .match-box:nth-child(odd)::before {
            content: ""; position: absolute; right: -25px; top: 50%; width: 2px; height: 100%; background: #555; transform: translateY(50%);
        }
        .round-column:last-child .match-box::after { display: none; }
        .round-column:last-child .match-box::before { display: none; }

        /* Admin Controls (Hover) */
        .controls { display: none; gap: 5px; }
        .player-slot:hover .controls { display: flex; }
        .btn-win { color: #2ed573; cursor: pointer; font-weight: bold; }
        .btn-lose { color: #ff4757; cursor: pointer; font-weight: bold; }

        /* Status Styles */
        .eliminated input { text-decoration: line-through; color: #777; }
        .winner input { color: #2ed573; font-weight: bold; }
        
        /* Inputs */
        .setup-box { background: #222; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="setup-box">
    <h2>üèÜ Tournament Bracket Maker</h2>
    <label>Total Players (Example: 4, 8, 16):</label>
    <input type="number" id="pCount" placeholder="8" style="padding:5px;">
    <button onclick="createBracket()">Generate Bracket</button>
    <button onclick="resetBracket()" style="background:#ff4757; color:white; border:none; padding:6px;">Reset All</button>
    <p style="color:gray; font-size:12px;">*Click name to edit. Hover for Win(‚úî)/Loss(‚úò) options.</p>
</div>

<div id="bracket-root" class="bracket-container"></div>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const bRef = db.ref('tournament_bracket');

    // 1. Create Structure in Firebase
    function createBracket() {
        const n = parseInt(document.getElementById('pCount').value);
        if(!n || (n & (n - 1)) !== 0) return alert("Please enter power of 2 (e.g. 2, 4, 8, 16)");

        let rounds = [];
        let matchCount = n / 2;
        let rNum = 1;

        while(matchCount >= 1) {
            let matches = [];
            for(let i=0; i<matchCount; i++) {
                matches.push({
                    id: `R${rNum}_M${i}`,
                    p1: (rNum===1) ? `Player ${i*2+1}` : "",
                    p2: (rNum===1) ? `Player ${i*2+2}` : "",
                    s1: "", // status p1 (win/loss)
                    s2: ""  // status p2
                });
            }
            rounds.push(matches);
            matchCount = matchCount / 2;
            rNum++;
        }
        bRef.set(rounds);
    }

    function resetBracket() { if(confirm("Clear all?")) bRef.remove(); }

    // 2. Render & Control Logic
    bRef.on('value', snap => {
        const data = snap.val();
        const root = document.getElementById('bracket-root');
        root.innerHTML = "";
        
        if(!data) return root.innerHTML = "<p>No tournament active.</p>";

        data.forEach((round, rIdx) => {
            const col = document.createElement('div');
            col.className = 'round-column';
            
            round.forEach((match, mIdx) => {
                // Determine Classes
                const c1 = match.s1 === 'lost' ? 'eliminated' : (match.s1 === 'win' ? 'winner' : '');
                const c2 = match.s2 === 'lost' ? 'eliminated' : (match.s2 === 'win' ? 'winner' : '');

                col.innerHTML += `
                    <div class="match-box">
                        <div class="player-slot ${c1}">
                            <input type="text" value="${match.p1}" onchange="updateName(${rIdx}, ${mIdx}, 'p1', this.value)">
                            <div class="controls">
                                <span class="btn-win" onclick="setWin(${rIdx}, ${mIdx}, 'p1', '${match.p1}')">‚úî</span>
                                <span class="btn-lose" onclick="setLose(${rIdx}, ${mIdx}, 'p1')">‚úò</span>
                            </div>
                        </div>
                        <div class="player-slot ${c2}">
                            <input type="text" value="${match.p2}" onchange="updateName(${rIdx}, ${mIdx}, 'p2', this.value)">
                            <div class="controls">
                                <span class="btn-win" onclick="setWin(${rIdx}, ${mIdx}, 'p2', '${match.p2}')">‚úî</span>
                                <span class="btn-lose" onclick="setLose(${rIdx}, ${mIdx}, 'p2')">‚úò</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            root.appendChild(col);
        });
    });

    // 3. Update Database Functions
    function updateName(r, m, p, val) {
        bRef.child(`${r}/${m}/${p}`).set(val);
    }

    function setLose(r, m, p) {
        // Set 'lost' status -> CSS Strikethrough
        const field = (p === 'p1') ? 's1' : 's2';
        bRef.child(`${r}/${m}/${field}`).set('lost');
    }

    function setWin(r, m, p, name) {
        if(!name) return alert("No name found!");
        
        // 1. Mark as winner visually
        const statusField = (p === 'p1') ? 's1' : 's2';
        bRef.child(`${r}/${m}/${statusField}`).set('win');

        // 2. Move to NEXT Round
        bRef.once('value', snap => {
            const rounds = snap.val();
            if(r + 1 < rounds.length) {
                const nextMatchIdx = Math.floor(m / 2); // Calculate parent match
                const nextSlot = (m % 2 === 0) ? 'p1' : 'p2'; // Even=Top, Odd=Bottom
                
                bRef.child(`${r+1}/${nextMatchIdx}/${nextSlot}`).set(name);
                // Reset status of next slot just in case
                bRef.child(`${r+1}/${nextMatchIdx}/${(nextSlot==='p1'?'s1':'s2')}`).set('');
            } else {
                alert("üèÜ TOURNAMENT CHAMPION: " + name);
            }
        });
    }
</script>
</body>
</html>
