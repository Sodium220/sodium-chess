<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Sodium Chess</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0b1e36; color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .box { background: #162a47; padding: 25px; border-radius: 12px; max-width: 600px; margin: auto; border: 1px solid #00d2ff; }
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 5px; border: none; width: 100%; box-sizing: border-box; }
        button { background: #00d2ff; color: #0b1e36; font-weight: bold; cursor: pointer; }
        button:hover { background: #00a6c9; }
        .match-card { background: #0f213a; padding: 10px; margin-top: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #00d2ff; }
        .generated-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .generated-row input { background: #0b1e36; color: white; border: 1px solid #444; }
        .squad-badge { background: #ff4757; color: white; font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-left: 5px; }
        .btn-group { display: flex; gap: 5px; }
        .btn-del { background: #ff4757; color: white; width: auto; }
        .btn-view { background: #2ed573; color: #0b1e36; width: auto; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="text-align:center; color:#00d2ff;">Tournament Center</h2>
        
        <div style="background:#0f213a; padding:15px; border-radius:8px;">
            <h3>Create Bracket</h3>
            <label>Mode:</label>
            <select id="gameMode">
                <option value="Solo">Solo (1v1)</option>
                <option value="Squad">Squad Battle</option>
            </select>
            
            <label>Time Control:</label>
            <select id="timeLimit">
                <option value="60">Bullet (1m)</option>
                <option value="180" selected>Blitz (3m)</option>
                <option value="600">Rapid (10m)</option>
            </select>

            <label>Total Players (Creates Boxes):</label>
            <input type="number" id="playerCount" placeholder="Ex: 4, 8, 16" min="2">
            <button onclick="generateBoxes()">Generate Boxes</button>

            <div id="manual-entry-area" style="margin-top:15px;"></div>
            <button id="publish-btn" class="hidden" onclick="publishMatches()" style="background:#2ed573;">Publish Bracket</button>
        </div>

        <hr style="border-color:#2a4a75;">
        
        <h3>Live Matches</h3>
        <div id="match-list"></div>
        
        <button onclick="localStorage.clear(); location.href='index.html'" style="background:#57606f; margin-top:20px;">Logout</button>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    if(localStorage.getItem("userRole") !== "admin") location.href = "index.html";

    function generateBoxes() {
        const count = parseInt(document.getElementById('playerCount').value);
        if(!count || count < 2 || count % 2 !== 0) return alert("Please enter an even number (2, 4, 8..)");
        
        const area = document.getElementById('manual-entry-area');
        area.innerHTML = "";
        
        const matches = count / 2;
        for(let i=0; i<matches; i++) {
            area.innerHTML += `
                <div class="generated-row" id="row-${i}">
                    <span>Match ${i+1}:</span>
                    <input type="text" placeholder="Player 1 (White)" class="p1-in">
                    <span>VS</span>
                    <input type="text" placeholder="Player 2 (Black)" class="p2-in">
                </div>
            `;
        }
        document.getElementById('publish-btn').style.display = 'block';
    }

    function publishMatches() {
        const rows = document.querySelectorAll('.generated-row');
        const time = parseInt(document.getElementById('timeLimit').value);
        const mode = document.getElementById('gameMode').value;
        let created = 0;

        rows.forEach(row => {
            const p1 = row.querySelector('.p1-in').value.trim().toLowerCase();
            const p2 = row.querySelector('.p2-in').value.trim().toLowerCase();
            
            if(p1 && p2) {
                const id = db.ref('matches').push().key;
                db.ref('matches/'+id).set({p1, p2, time, type: mode, id});
                db.ref('live_matches/'+id).set({
                    timeLeftW: time, timeLeftB: time, status: 'waiting', turn: 'w', f: 'start'
                });
                created++;
            }
        });

        if(created > 0) {
            alert(`${created} matches published successfully!`);
            document.getElementById('manual-entry-area').innerHTML = "";
            document.getElementById('publish-btn').style.display = 'none';
        } else {
            alert("Please fill in player names.");
        }
    }

    db.ref('matches').on('value', snap => {
        const list = document.getElementById('match-list');
        list.innerHTML = "";
        const data = snap.val();
        if(!data) return list.innerHTML = "<p style='text-align:center; color:#777'>No active matches.</p>";
        
        Object.keys(data).forEach(k => {
            const m = data[k];
            list.innerHTML += `
                <div class="match-card">
                    <div>
                        <b>${m.p1}</b> vs <b>${m.p2}</b> 
                        ${m.type === 'Squad' ? '<span class="squad-badge">SQUAD</span>' : ''}
                    </div>
                    <div class="btn-group">
                        <button class="btn-view" onclick="location.href='game.html?id=${k}'">View</button>
                        <button class="btn-del" onclick="deleteMatch('${k}')">Del</button>
                    </div>
                </div>`;
        });
    });

    function deleteMatch(k) {
        if(confirm("Delete this match?")) {
            db.ref('matches/'+k).remove();
            db.ref('live_matches/'+k).remove();
        }
    }
</script>
</body>
</html>
