<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Admin - Tournament Control</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0b1e36; color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .box { background: #162a47; padding: 25px; border-radius: 12px; max-width: 700px; margin: auto; border: 1px solid #00d2ff; }
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 5px; border: none; width: 100%; box-sizing: border-box; }
        button { background: #00d2ff; color: #0b1e36; font-weight: bold; cursor: pointer; }
        button:hover { background: #00a6c9; }
        .match-item { background: #0f213a; padding: 10px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #ffd32a; }
        .row-inputs { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="box">
        <h2 style="text-align:center; color:#00d2ff;">Tournament Manager</h2>
        
        <div style="background:#0f213a; padding:15px; border-radius:8px;">
            <h3>Create Match Slot</h3>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>Round Name:</label>
                    <select id="roundSelect">
                        <option value="Round 1">Round 1 (Prelims)</option>
                        <option value="Quarter Final">Quarter Final</option>
                        <option value="Semi Final">Semi Final</option>
                        <option value="Final">Grand Final</option>
                    </select>
                </div>
                <div>
                    <label>Mode:</label>
                    <select id="modeSelect">
                        <option value="Solo">Solo (1v1)</option>
                        <option value="Squad">Squad</option>
                    </select>
                </div>
            </div>

            <label>Time Control (Seconds):</label>
            <select id="timeSelect">
                <option value="180">Blitz (3 min)</option>
                <option value="600">Rapid (10 min)</option>
                <option value="60">Bullet (1 min)</option>
            </select>

            <hr style="border-color:#2a4a75">
            <label>Generate Slots (Active Players):</label>
            <input type="number" id="boxCount" placeholder="Number of players (e.g. 4, 8)" min="2">
            <button onclick="generateInputs()">Generate Slots</button>

            <div id="input-area" style="margin-top:15px;"></div>
            <button id="pub-btn" onclick="publish()" class="hidden" style="background:#2ed573; display:none;">Publish to Bracket</button>
        </div>

        <h3>Active Matches</h3>
        <div id="match-list"></div>
        <button onclick="localStorage.clear(); location.href='index.html'" style="background:#ff4757; margin-top:20px;">Logout</button>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    if(localStorage.getItem("userRole") !== "admin") location.href = "index.html";

    function generateInputs() {
        const n = parseInt(document.getElementById('boxCount').value);
        if(!n || n%2!==0) return alert("Please enter an even number (2, 4, 8)");
        
        const area = document.getElementById('input-area');
        area.innerHTML = "";
        for(let i=0; i<n/2; i++) {
            area.innerHTML += `
                <div class="row-inputs">
                    <input type="text" placeholder="White Player" class="p1">
                    <span style="align-self:center; font-weight:bold; color:#777">VS</span>
                    <input type="text" placeholder="Black Player" class="p2">
                </div>`;
        }
        document.getElementById('pub-btn').style.display = 'block';
    }

    function publish() {
        const round = document.getElementById('roundSelect').value;
        const mode = document.getElementById('modeSelect').value;
        const time = parseInt(document.getElementById('timeSelect').value);
        const rows = document.querySelectorAll('.row-inputs');
        let count = 0;

        rows.forEach(r => {
            const p1 = r.querySelector('.p1').value.toLowerCase().trim();
            const p2 = r.querySelector('.p2').value.toLowerCase().trim();
            if(p1 && p2) {
                const id = db.ref('matches').push().key;
                db.ref('matches/'+id).set({p1, p2, time, round, mode, id});
                db.ref('live_matches/'+id).set({timeLeftW:time, timeLeftB:time, status:'waiting', turn:'w', f:'start'});
                count++;
            }
        });
        
        if(count>0) {
            alert(count + " matches published to " + round);
            document.getElementById('input-area').innerHTML = "";
            document.getElementById('pub-btn').style.display = 'none';
        }
    }

    db.ref('matches').on('value', snap => {
        const div = document.getElementById('match-list');
        div.innerHTML = "";
        const data = snap.val();
        if(data) {
            Object.keys(data).forEach(k => {
                const m = data[k];
                div.innerHTML += `
                    <div class="match-item">
                        <span>[${m.round}] <b>${m.p1}</b> vs <b>${m.p2}</b></span>
                        <div style="display:flex; gap:5px;">
                            <button onclick="location.href='game.html?id=${k}'" style="width:auto; padding:5px 10px; background:#2ed573; color:black">View</button>
                            <button onclick="del('${k}')" style="width:auto; padding:5px 10px; background:#ff4757;">X</button>
                        </div>
                    </div>`;
            });
        }
    });

    function del(k) {
        if(confirm("Delete match?")) {
            db.ref('matches/'+k).remove();
            db.ref('live_matches/'+k).remove();
        }
    }
</script>
</body>
</html>
