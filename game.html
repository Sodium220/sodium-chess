<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Live Secure Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a2e; color: white; text-align: center; font-family: sans-serif; }
        #board { width: 400px; margin: 20px auto; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: #16213e; padding: 30px; border-radius: 15px; border: 2px solid #e94560; }
        button { padding: 10px 20px; cursor: pointer; background: #e94560; color: white; border: none; border-radius: 5px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="wait-screen" class="overlay">
        <div class="modal">
            <h2 id="wait-msg">প্লেয়ারের জন্য অপেক্ষা করা হচ্ছে...</h2>
            <div id="accept-div" class="hidden">
                <p>বিপক্ষ প্লেয়ার প্রস্তুত! আপনি কি তৈরি?</p>
                <button onclick="iAmReady()">Accept & Start</button>
            </div>
        </div>
    </div>

    <h2 id="status">ম্যাচ লোড হচ্ছে...</h2>
    <div id="board"></div>
    <p id="player-info"></p>
    <button onclick="window.history.back()">Exit Match</button>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('id');
    const myName = localStorage.getItem("playerName");
    const myRole = localStorage.getItem("userRole");

    let board = null;
    let game = new Chess();
    let myColor = null; // 'w' or 'b'
    const matchRef = db.ref('matches/' + matchId);
    const liveRef = db.ref('live_matches/' + matchId);

    // ১. গেম শুরু হওয়ার লজিক (Ready Check)
    matchRef.once('value', snap => {
        const data = snap.val();
        if (myRole === 'admin') {
            document.getElementById('wait-screen').classList.add('hidden');
            initBoard('white'); // Admin sees from white perspective
        } else {
            // প্লেয়ারের কালার নির্ধারণ
            if (data.p1 === myName) myColor = 'w';
            else if (data.p2 === myName) myColor = 'b';
            
            initBoard(myColor === 'w' ? 'white' : 'black');
            checkReadyStatus();
        }
    });

    function checkReadyStatus() {
        const readyRef = db.ref('ready_status/' + matchId + '/' + myName);
        readyRef.set(true); // আমি রেডি

        db.ref('ready_status/' + matchId).on('value', snap => {
            const players = snap.val() || {};
            const count = Object.keys(players).length;
            
            if (count === 2) {
                document.getElementById('wait-msg').innerText = "উভয় প্লেয়ার অনলাইনে আছে!";
                document.getElementById('accept-div').classList.remove('hidden');
            }
        });
    }

    function iAmReady() {
        document.getElementById('wait-screen').classList.add('hidden');
    }

    // ২. বোর্ড এবং চাল লজিক
    function onDragStart (source, piece, position, orientation) {
        if (game.game_over()) return false;
        if (myRole === 'admin') return false; // Admin can't move
        
        // শুধু নিজের কালারের গুটি চালতে পারবে
        if ((myColor === 'w' && piece.search(/^b/) !== -1) ||
            (myColor === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }

        // যার চাল কেবল সে চালতে পারবে
        if ((game.turn() === 'w' && myColor !== 'w') ||
            (game.turn() === 'b' && myColor !== 'b')) {
            return false;
        }
    }

    function onDrop (source, target) {
        let move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';
        liveRef.set({ fen: game.fen() });
    }

    function initBoard(orientation) {
        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            orientation: orientation, // ব্ল্যাক প্লেয়ারের জন্য বোর্ড ঘুরে যাবে
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    }

    liveRef.on('value', snap => {
        const data = snap.val();
        if (data && data.fen) {
            game.load(data.fen);
            board.position(data.fen);
        }
        updateStatus();
    });

    function updateStatus() {
        let status = game.turn() === 'w' ? "White's Turn" : "Black's Turn";
        if (game.in_checkmate()) status = "Game Over - Checkmate!";
        document.getElementById('status').innerText = status;
    }
</script>
</body>
</html>