<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Match Live - Sodium Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0f3460; color: white; text-align: center; font-family: sans-serif; margin: 0; }
        #board { width: 360px; margin: 10px auto; border: 5px solid #16213e; border-radius: 10px; }
        .clocks { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .clock { background: #16213e; padding: 10px; width: 100px; border-radius: 8px; font-size: 22px; border: 2px solid transparent; }
        .active-clock { border-color: #e94560; background: #1a1a2e; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; }
        .modal { background: #16213e; padding: 30px; border-radius: 15px; border: 2px solid #e94560; }
        button { background: #e94560; color: white; border: none; padding: 12px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="wait-screen" class="overlay">
        <div class="modal">
            <h2 id="wait-text">Waiting for Players...</h2>
            <button id="ready-btn" onclick="setReady()">I'm Ready</button>
        </div>
    </div>

    <div id="end-screen" class="overlay hidden">
        <div class="modal">
            <h1 id="win-msg">Match Ended</h1>
            <p id="reason">Reason</p>
            <button onclick="location.href='player_dashboard.html'">ড্যাশবোর্ড-এ ফিরুন</button>
        </div>
    </div>

    <div class="clocks">
        <div id="clock-w" class="clock">00:00</div>
        <div id="clock-b" class="clock">00:00</div>
    </div>
    <div id="board"></div>
    <h3 id="status">প্লেয়ার কানেক্ট হচ্ছে...</h3>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const mid = new URLSearchParams(window.location.search).get('id');
    const me = localStorage.getItem("username");
    
    let game = new Chess(), board = null, myCol = null, isEnded = false;
    const lRef = db.ref('live_matches/'+mid);

    function setReady() {
        if(!myCol) return alert("আপনি দর্শক হিসেবে দেখছেন।");
        if(myCol === 'w') lRef.update({wR:true}); else lRef.update({bR:true});
        document.getElementById('ready-btn').innerText = "Waiting...";
    }

    function onDragStart(s, p) {
        if(isEnded || game.game_over() || !myCol || (game.turn() !== myCol) || (p.search(myCol) === -1)) return false;
    }

    function onDrop(s, t) {
        let move = game.move({from:s, to:t, promotion:'q'});
        if (!move) return 'snapback';
        lRef.update({f: game.fen(), turn: game.turn()});
        if(game.in_checkmate()) declareWinner(myCol === 'w' ? "White" : "Black", "Checkmate");
    }

    function declareWinner(w, r) {
        if(isEnded) return;
        lRef.update({status:'ended', winner:w, reason:r});
        db.ref('users/'+w.toLowerCase()+'/stats/wins').transaction(c => (c||0)+1);
    }

    function startTimer() {
        if(window.gameTimer) return;
        window.gameTimer = setInterval(() => {
            lRef.once('value', snap => {
                const d = snap.val();
                if(!d || d.status !== 'playing' || isEnded) return;
                if(game.turn() === 'w') {
                    let t = d.timeLeftW - 1;
                    if(t<=0) declareWinner("Black", "Time Expired"); else if(myCol === 'w') lRef.update({timeLeftW:t});
                } else {
                    let t = d.timeLeftB - 1;
                    if(t<=0) declareWinner("White", "Time Expired"); else if(myCol === 'b') lRef.update({timeLeftB:t});
                }
            });
        }, 1000);
    }

    lRef.on('value', snap => {
        const d = snap.val(); if(!d) return;
        if(d.wR && d.bR && d.status === 'waiting') lRef.update({status:'playing'});
        if(d.status === 'playing') { document.getElementById('wait-screen').classList.add('hidden'); startTimer(); }
        if(d.status === 'ended') {
            isEnded = true; clearInterval(window.gameTimer);
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('win-msg').innerText = d.winner + " Wins!";
            document.getElementById('reason').innerText = d.reason;
            return;
        }
        if(d.f && d.f !== game.fen()) { game.load(d.f); board.position(d.f); }
        document.getElementById('clock-w').innerText = format(d.timeLeftW);
        document.getElementById('clock-b').innerText = format(d.timeLeftB);
        document.getElementById('clock-w').className = game.turn()==='w'?"clock active-clock":"clock";
        document.getElementById('clock-b').className = game.turn()==='b'?"clock active-clock":"clock";
        document.getElementById('status').innerText = game.turn()==='w'?"White's Turn":"Black's Turn";
    });

    function format(s) { let m=Math.floor(s/60); let sec=s%60; return (m<10?"0":"")+m+":"+(sec<10?"0":"")+sec; }

    db.ref('matches/'+mid).once('value', snap => {
        const m = snap.val();
        if(m.p1 === me) myCol='w'; else if(m.p2 === me) myCol='b';
        board = Chessboard('board', {
            draggable: true, position: 'start', orientation: (myCol==='b'?'black':'white'),
            onDragStart: onDragStart, onDrop: onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        if(!myCol) document.getElementById('ready-btn').classList.add('hidden');
    });
</script>
</body>
</html>
