<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sodium Chess - Live Match</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --bg: #050a12; --card: #162231; --primary: #00d2ff; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; touch-action: manipulation; }
        .game-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 10px; }
        #board { width: 95vw; max-width: 380px; border: 4px solid #2a3a4d; border-radius: 5px; }
        .player-info { width: 100%; max-width: 380px; background: var(--card); padding: 12px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; border: 1px solid #2a3a4d; }
        .highlight-sq { box-shadow: inset 0 0 5px 5px rgba(255, 255, 0, 0.7); background: rgba(255, 255, 0, 0.2) !important; }
        .turn-indicator { color: var(--primary); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .active-player { border: 2px solid var(--primary); }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="turn-indicator" id="status-text">Connecting to Match...</div>
    
    <div class="player-info" id="opp-box">
        <span id="opp-name">Opponent</span>
        <span id="opp-status">Wait...</span>
    </div>

    <div id="board"></div>

    <div class="player-info" id="my-box">
        <span id="my-name">You</span>
        <span id="my-status">Ready</span>
    </div>
</div>

<script>
    // ফায়ারবেস কনফিগ
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ইউআরএল থেকে ম্যাচ আইডি এবং প্লেয়ার নাম নেওয়া
    const urlParams = new URLSearchParams(window.location.search);
    const mid = urlParams.get('id'); 
    const me = localStorage.getItem("username");

    let board = null;
    let game = new Chess();
    let myColor = 'w'; 
    let sourceSquare = null;

    if (!mid) {
        alert("Match ID not found!");
        location.href = 'player.html';
    }

    // ১. ম্যাচ ডাটাবেস সেটআপ এবং কালার নির্ধারণ
    const matchRef = db.ref('live_matches/' + mid);

    matchRef.once('value', snap => {
        let data = snap.val();
        
        // যদি ডাটা না থাকে তবে নতুন ম্যাচ তৈরি
        if (!data) {
            data = { fen: 'start', turn: 'w', p1: me, p2: 'Waiting...' };
            matchRef.set(data);
        }

        // কালার লজিক: প্রথম জন হোয়াইট (p1), দ্বিতীয় জন ব্ল্যাক (p2)
        if (data.p1 === me) {
            myColor = 'w';
        } else if (data.p2 === me) {
            myColor = 'b';
        } else if (data.p2 === 'Waiting...') {
            myColor = 'b';
            matchRef.update({ p2: me }); // দ্বিতীয় জন জয়েন করলে নাম আপডেট
        } else {
            // দর্শক মোড
            myColor = 's';
            document.getElementById('status-text').innerText = "Spectating Mode";
        }

        document.getElementById('my-name').innerText = me + (myColor !== 's' ? ` (${myColor === 'w' ? 'White' : 'Black'})` : "");
        initBoard();
    });

    // ২. বোর্ড এবং ক্লিক লজিক
    function initBoard() {
        let config = {
            draggable: false, // মোবাইলে ক্লিক টু মুভ এর জন্য ড্র্যাগ বন্ধ
            position: 'start',
            orientation: myColor === 'b' ? 'black' : 'white',
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        board = Chessboard('board', config);

        // ক্লিক ইভেন্ট
        $('#board').on('click', '.square-55d6', function() {
            if (myColor === 's') return; // দর্শক চাল দিতে পারবে না
            let square = $(this).attr('data-square');
            handleMove(square);
        });

        listenForMoves();
    }

    function handleMove(square) {
        if (game.turn() !== myColor) return; // নিজের চাল না হলে কিছু হবে না

        if (sourceSquare === null) {
            let piece = game.get(square);
            if (piece && piece.color === myColor) {
                sourceSquare = square;
                $('.square-55d6').removeClass('highlight-sq');
                $('.square-' + square).addClass('highlight-sq');
            }
        } else {
            let move = game.move({ from: sourceSquare, to: square, promotion: 'q' });
            
            if (move === null) {
                // ভুল চাল দিলে সিলেকশন চেঞ্জ
                let piece = game.get(square);
                if (piece && piece.color === myColor) {
                    sourceSquare = square;
                    $('.square-55d6').removeClass('highlight-sq');
                    $('.square-' + square).addClass('highlight-sq');
                }
            } else {
                // সঠিক চাল
                board.position(game.fen());
                $('.square-55d6').removeClass('highlight-sq');
                sourceSquare = null;
                matchRef.update({ fen: game.fen(), turn: game.turn() });
            }
        }
    }

    // ৩. রিয়েল-টাইম সিঙ্ক
    function listenForMoves() {
        matchRef.on('value', snap => {
            const data = snap.val();
            if (!data) return;

            if (data.fen === 'start') {
                game.reset();
                board.start();
            } else {
                game.load(data.fen);
                board.position(data.fen);
            }

            // টার্ন আপডেট
            let turn = data.turn;
            document.getElementById('status-text').innerText = turn === myColor ? "YOUR TURN" : "Opponent's Turn";
            document.getElementById('my-box').classList.toggle('active-player', turn === myColor);
            document.getElementById('opp-box').classList.toggle('active-player', turn !== myColor);
            
            // অপোনেন্ট নাম আপডেট
            document.getElementById('opp-name').innerText = (myColor === 'w' ? data.p2 : data.p1);

            if (game.game_over()) {
                document.getElementById('status-text').innerText = "GAME OVER!";
                alert("Game Over!");
            }
        });
    }
</script>
</body>
</html>
