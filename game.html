<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Advanced Live Chess</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #1a1a2e; color: white; text-align: center; font-family: sans-serif; }
        #board { width: 400px; margin: 20px auto; }
        .clocks { display: flex; justify-content: space-around; max-width: 400px; margin: auto; }
        .clock { background: #16213e; padding: 10px 20px; border-radius: 8px; font-size: 24px; border: 2px solid #e94560; min-width: 100px;}
        .active-clock { background: #e94560; color: white; }
        /* গুটি চালার সাজেশন এর জন্য স্টাইল */
        .highlight-sq { box-shadow: inset 0 0 3px 3px yellow; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; z-index:1000;}
        .mode-btn { padding: 15px; margin: 10px; cursor: pointer; background: #24a0ed; color: white; border:none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="mode-screen" class="overlay">
        <div style="background:#16213e; padding:30px; border-radius:15px;">
            <h2>গেম মোড সিলেক্ট করুন</h2>
            <button class="mode-btn" onclick="startWithMode(60)">Bullet (1 Min)</button>
            <button class="mode-btn" onclick="startWithMode(180)">Blitz (3 Min)</button>
            <button class="mode-btn" onclick="startWithMode(600)">Rapid (10 Min)</button>
        </div>
    </div>

    <div class="clocks">
        <div id="clock-w" class="clock">White: 10:00</div>
        <div id="clock-b" class="clock">Black: 10:00</div>
    </div>

    <h2 id="status">প্লেয়ারের জন্য অপেক্ষা...</h2>
    <div id="board"></div>
    <button onclick="window.history.back()">Exit</button>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const matchId = urlParams.get('id');
    const myName = localStorage.getItem("playerName");
    const myRole = localStorage.getItem("userRole");

    let board = null;
    let game = new Chess();
    let myColor = null;
    let timerInterval = null;
    let timeLimit = 600; // ডিফল্ট ১০ মিনিট

    const liveRef = db.ref('live_matches/' + matchId);

    // ১. গেম মোড সেটআপ
    function startWithMode(seconds) {
        timeLimit = seconds;
        document.getElementById('mode-screen').classList.add('hidden');
        if (myRole !== 'admin') {
            liveRef.update({ 
                timeLeftW: seconds, 
                timeLeftB: seconds, 
                modeSelected: true,
                lastMoveTime: Date.now() 
            });
        }
    }

    // ২. গুটি কোথায় যাবে সেটি হাইলাইট করা (Suggestion)
    function onMouseoverSquare (square, piece) {
        if (myRole === 'admin') return;
        let moves = game.moves({ square: square, verbose: true });
        if (moves.length === 0) return;

        $('#board .square-' + square).addClass('highlight-sq');
        for (let i = 0; i < moves.length; i++) {
            $('#board .square-' + moves[i].to).addClass('highlight-sq');
        }
    }

    function onMouseoutSquare (square, piece) {
        $('#board .square-55d6').removeClass('highlight-sq'); // সব রিমুভ হবে
        $('.square-55d6').removeClass('highlight-sq');
        $('#board [class*="square-"]').removeClass('highlight-sq');
    }

    // ৩. গেম লজিক
    function onDragStart (source, piece) {
        if (game.game_over() || myRole === 'admin') return false;
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) return false;
    }

    function onDrop (source, target) {
        let move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';
        
        liveRef.update({ 
            fen: game.fen(), 
            lastMoveTime: Date.now(),
            turn: game.turn() 
        });
    }

    // ৪. ঘড়ি (Timer) চালানো
    function startClocks() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            liveRef.once('value', snap => {
                let data = snap.val();
                if (!data || game.game_over()) return;

                let now = Date.now();
                let diff = Math.floor((now - data.lastMoveTime) / 1000);
                
                if (game.turn() === 'w') {
                    let newTime = data.timeLeftW - 1;
                    if (newTime <= 0) endGame("Black wins by time!");
                    if (myRole !== 'admin' && game.turn() === 'w') liveRef.update({ timeLeftW: newTime, lastMoveTime: now });
                } else {
                    let newTime = data.timeLeftB - 1;
                    if (newTime <= 0) endGame("White wins by time!");
                    if (myRole !== 'admin' && game.turn() === 'b') liveRef.update({ timeLeftB: newTime, lastMoveTime: now });
                }
            });
        }, 1000);
    }

    function formatTime(sec) {
        let m = Math.floor(sec / 60);
        let s = sec % 60;
        return (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
    }

    liveRef.on('value', snap => {
        const data = snap.val();
        if (!data) return;

        if (data.modeSelected) document.getElementById('mode-screen').style.display = 'none';

        if (data.fen) {
            game.load(data.fen);
            board.position(data.fen);
        }

        document.getElementById('clock-w').innerText = "White: " + formatTime(data.timeLeftW);
        document.getElementById('clock-b').innerText = "Black: " + formatTime(data.timeLeftB);
        
        // কে চালছে তাকে হাইলাইট করা
        document.getElementById('clock-w').className = game.turn() === 'w' ? "clock active-clock" : "clock";
        document.getElementById('clock-b').className = game.turn() === 'b' ? "clock active-clock" : "clock";

        updateStatus();
    });

    function init() {
        db.ref('matches/' + matchId).once('value', snap => {
            const m = snap.val();
            let orient = (m.p1 === myName) ? 'white' : 'black';
            board = Chessboard('board', {
                draggable: true,
                position: 'start',
                orientation: orient,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onMouseoverSquare: onMouseoverSquare,
                onMouseoutSquare: onMouseoutSquare,
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
        });
    }

    function updateStatus() {
        let status = game.turn() === 'w' ? "White's Turn" : "Black's Turn";
        if (game.in_check()) status += " (CHECK!)";
        if (game.in_checkmate()) status = "Game Over - Checkmate!";
        document.getElementById('status').innerText = status;
    }

    init();
</script>
</body>
</html>