<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Live Match</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0b1e36; color: white; text-align: center; font-family: 'Segoe UI', sans-serif; margin: 0; }
        #board { width: 100%; max-width: 400px; margin: 10px auto; border: 5px solid #162a47; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .info-bar { display: flex; justify-content: space-between; max-width: 400px; margin: 10px auto; padding: 0 10px; }
        .clock { background: #162a47; padding: 8px 15px; border-radius: 6px; font-size: 24px; font-family: monospace; border: 2px solid #0f213a; width: 80px; }
        .active-clock { border-color: #00d2ff; color: #00d2ff; box-shadow: 0 0 10px rgba(0,210,255,0.3); }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11, 30, 54, 0.95); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .modal { background: #162a47; padding: 40px; border-radius: 15px; border: 2px solid #00d2ff; text-align: center; }
        button { background: #00d2ff; color: #0b1e36; border: none; padding: 12px 30px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 15px; }
        .hidden { display: none !important; }
        h1 { margin: 0 0 10px 0; }
    </style>
</head>
<body>

    <div id="wait-screen" class="overlay">
        <div class="modal">
            <h2 id="wait-text">Connecting...</h2>
            <button id="ready-btn" onclick="setReady()">I'm Ready</button>
        </div>
    </div>

    <div id="end-screen" class="overlay hidden">
        <div class="modal">
            <h1 id="win-msg">Game Over</h1>
            <p id="reason" style="color:#aaa;">Checkmate</p>
            <button onclick="location.href='player.html'">Back to Dashboard</button>
        </div>
    </div>

    <div class="info-bar">
        <span id="player-b">Black</span>
        <div id="clock-b" class="clock">00:00</div>
    </div>
    
    <div id="board"></div>
    
    <div class="info-bar">
        <span id="player-w">White</span>
        <div id="clock-w" class="clock">00:00</div>
    </div>
    
    <h3 id="status" style="color:#00d2ff; margin-top:10px;">Waiting...</h3>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    const urlParams = new URLSearchParams(window.location.search);
    const mid = urlParams.get('id');
    const me = localStorage.getItem("username");
    
    let game = new Chess();
    let board = null;
    let myCol = null; 
    let isEnded = false;
    let timerInterval = null;

    const lRef = db.ref('live_matches/'+mid);

    // Initial Setup
    db.ref('matches/'+mid).once('value', snap => {
        const m = snap.val();
        if(!m) return alert("Match not found!");

        document.getElementById('player-w').innerText = m.p1;
        document.getElementById('player-b').innerText = m.p2;

        if(m.p1 === me) myCol = 'w';
        else if(m.p2 === me) myCol = 'b';
        else {
            myCol = null; // Spectator/Admin
            document.getElementById('ready-btn').style.display = 'none';
            document.getElementById('wait-text').innerText = "Spectator Mode";
        }

        board = Chessboard('board', {
            draggable: true,
            position: 'start',
            orientation: (myCol === 'b') ? 'black' : 'white',
            onDragStart: onDragStart,
            onDrop: onDrop,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    });

    function setReady() {
        if(myCol === 'w') lRef.update({wR:true});
        if(myCol === 'b') lRef.update({bR:true});
        document.getElementById('ready-btn').innerText = "Waiting for opponent...";
        document.getElementById('ready-btn').disabled = true;
    }

    function onDragStart(s, p) {
        if(isEnded || game.game_over() || !myCol || game.turn() !== myCol || p.search(myCol) === -1) return false;
    }

    function onDrop(s, t) {
        let move = game.move({from:s, to:t, promotion:'q'});
        if (!move) return 'snapback';
        
        lRef.update({f: game.fen(), turn: game.turn()});
        
        if(game.in_checkmate()) declareWinner(myCol === 'w' ? "White" : "Black", "Checkmate");
        else if(game.in_draw()) declareWinner("Draw", "Draw");
    }

    function declareWinner(winnerColor, reason) {
        if(isEnded) return;
        let winnerName = "";
        
        if(winnerColor === "White") winnerName = document.getElementById('player-w').innerText;
        else if(winnerColor === "Black") winnerName = document.getElementById('player-b').innerText;
        else winnerName = "Draw";

        lRef.update({status:'ended', winner: winnerName, reason: reason});
        
        // Update Stats Logic
        if(winnerName !== "Draw") {
            // Winner gets +1 win, +1 total
            db.ref('users/'+winnerName.toLowerCase()+'/stats').transaction(s => {
                if(!s) s = {wins:0, total:0};
                s.wins++; s.total++;
                return s;
            });
            // Loser gets +1 total
            let loser = (winnerColor === "White") ? document.getElementById('player-b').innerText : document.getElementById('player-w').innerText;
            db.ref('users/'+loser.toLowerCase()+'/stats/total').transaction(t => (t||0)+1);
        }
    }

    function startTimer() {
        if(timerInterval) return;
        timerInterval = setInterval(() => {
            if(isEnded) return;
            lRef.once('value', snap => {
                const d = snap.val();
                if(!d || d.status !== 'playing') return;

                if(game.turn() === 'w') {
                    let t = d.timeLeftW - 1;
                    if(t <= 0) declareWinner("Black", "Time Expired");
                    else if(myCol === 'w') lRef.update({timeLeftW: t});
                } else {
                    let t = d.timeLeftB - 1;
                    if(t <= 0) declareWinner("White", "Time Expired");
                    else if(myCol === 'b') lRef.update({timeLeftB: t});
                }
            });
        }, 1000);
    }

    lRef.on('value', snap => {
        const d = snap.val();
        if(!d) return;

        // Start Game Logic
        if(d.wR && d.bR && d.status === 'waiting') lRef.update({status:'playing'});
        
        if(d.status === 'playing') {
            document.getElementById('wait-screen').classList.add('hidden');
            startTimer();
        }

        // End Game Logic
        if(d.status === 'ended') {
            isEnded = true;
            clearInterval(timerInterval);
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('win-msg').innerText = d.winner === "Draw" ? "Match Drawn" : d.winner + " Wins!";
            document.getElementById('reason').innerText = d.reason;
            return;
        }

        // Update Board
        if(d.f && d.f !== game.fen()) {
            game.load(d.f);
            board.position(d.f);
        }

        // Update Clocks
        updateClock('clock-w', d.timeLeftW, game.turn() === 'w');
        updateClock('clock-b', d.timeLeftB, game.turn() === 'b');
        document.getElementById('status').innerText = game.turn() === 'w' ? "White's Turn" : "Black's Turn";
    });

    function updateClock(id, time, isActive) {
        let m = Math.floor(time / 60);
        let s = time % 60;
        let el = document.getElementById(id);
        el.innerText = (m<10?"0":"")+m + ":" + (s<10?"0":"")+s;
        el.className = isActive ? "clock active-clock" : "clock";
    }
</script>
</body>
</html>
