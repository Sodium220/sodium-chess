<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Live Arena</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0b1e36; color: white; text-align: center; font-family: sans-serif; margin: 0; }
        #board { width: 100%; max-width: 420px; margin: 10px auto; border: 5px solid #162a47; border-radius: 8px; }
        .clock-bar { display: flex; justify-content: space-between; max-width: 420px; margin: 5px auto; padding: 0 10px; }
        .clock { font-size: 24px; font-family: monospace; background: #162a47; padding: 5px 15px; border-radius: 5px; border: 2px solid transparent; }
        .active-clock { border-color: #00d2ff; color: #00d2ff; background: #0f213a; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(11,30,54, 0.95); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal { background: #162a47; padding: 40px; border-radius: 10px; border: 1px solid #00d2ff; }
        button { padding: 10px 20px; background: #00d2ff; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="wait-screen" class="overlay">
    <div class="modal">
        <h2 id="wait-text">Connecting...</h2>
        <button id="r-btn" onclick="ready()">I'm Ready</button>
    </div>
</div>

<div id="end-screen" class="overlay hidden">
    <div class="modal">
        <h1 id="win-msg">Game Over</h1>
        <p id="reason"></p>
        <button onclick="location.href='player.html'">Return to Bracket</button>
    </div>
</div>

<div class="clock-bar">
    <span>Black</span> <div id="cb" class="clock">00:00</div>
</div>
<div id="board"></div>
<div class="clock-bar">
    <span>White</span> <div id="cw" class="clock">00:00</div>
</div>
<h4 id="status" style="color:#00d2ff">...</h4>

<script>
    const firebaseConfig = { databaseURL: "https://sodium-chess-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const mid = new URLSearchParams(window.location.search).get('id');
    const me = localStorage.getItem("username");
    
    let game = new Chess(), board, myCol, isEnded=false, timerInt;
    const lRef = db.ref('live_matches/'+mid);

    db.ref('matches/'+mid).once('value', snap => {
        const m = snap.val();
        if(m.p1 === me) myCol='w'; else if(m.p2 === me) myCol='b';
        else { document.getElementById('wait-text').innerText="Spectator Mode"; document.getElementById('r-btn').style.display='none'; }
        
        board = Chessboard('board', {
            draggable: true, position: 'start', orientation: (myCol==='b'?'black':'white'),
            onDragStart: (s,p) => !isEnded && !game.game_over() && myCol && game.turn()===myCol && p.search(myCol)!==-1,
            onDrop: (s,t) => {
                let m = game.move({from:s, to:t, promotion:'q'});
                if(!m) return 'snapback';
                lRef.update({f:game.fen(), turn:game.turn()});
                if(game.in_checkmate()) end(myCol==='w'?"White":"Black", "Checkmate");
                else if(game.in_draw()) end("Draw", "Draw");
            },
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
    });

    function ready() {
        if(myCol==='w') lRef.update({wR:true}); else lRef.update({bR:true});
        document.getElementById('r-btn').innerText = "Waiting for opponent...";
    }

    function end(w, r) {
        if(isEnded) return;
        lRef.update({status:'ended', winner:w, reason:r});
        
        // Update Leaderboard Stats
        if(w !== "Draw") {
            // Get actual username from the match data to ensure correctness
            db.ref('matches/'+mid).once('value', snap => {
                const mData = snap.val();
                const winnerName = (w === "White") ? mData.p1 : mData.p2;
                db.ref('users/'+winnerName.toLowerCase()+'/stats/wins').transaction(c => (c||0)+1);
            });
        }
    }

    lRef.on('value', snap => {
        const d = snap.val();
        if(!d) return;
        
        if(d.status==='waiting' && d.wR && d.bR) lRef.update({status:'playing'});
        if(d.status==='playing') {
            document.getElementById('wait-screen').classList.add('hidden');
            if(!timerInt) timerInt = setInterval(tick, 1000);
        }
        if(d.status==='ended') {
            isEnded=true; clearInterval(timerInt);
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('win-msg').innerText = d.winner === "Draw" ? "Draw" : d.winner + " Wins!";
            document.getElementById('reason').innerText = d.reason;
        }

        if(d.f && d.f!==game.fen()) { game.load(d.f); board.position(d.f); }
        
        document.getElementById('cw').innerText = fmt(d.timeLeftW);
        document.getElementById('cb').innerText = fmt(d.timeLeftB);
        document.getElementById('cw').className = game.turn()==='w'?"clock active-clock":"clock";
        document.getElementById('cb').className = game.turn()==='b'?"clock active-clock":"clock";
        document.getElementById('status').innerText = game.turn()==='w'?"White to move":"Black to move";
    });

    function tick() {
        lRef.once('value', s => {
            const d = s.val();
            if(d.status!=='playing' || isEnded) return;
            if(game.turn()==='w') {
                if(d.timeLeftW<=0) end("Black","Time"); else if(myCol==='w') lRef.update({timeLeftW:d.timeLeftW-1});
            } else {
                if(d.timeLeftB<=0) end("White","Time"); else if(myCol==='b') lRef.update({timeLeftB:d.timeLeftB-1});
            }
        });
    }
    function fmt(s) { return Math.floor(s/60)+":"+(s%60<10?"0":"")+(s%60); }
</script>
</body>
</html>
